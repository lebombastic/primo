import{a as $,t as P,c as ge}from"./disclose-version.DwtFBC9D.js";import{p as Me,J as Qe,K as Te,g as e,q as i,f as oe,c as ae,r as Y,s as F,t as J,a as Ze,S as v,T as ne,d as l,v as Ie}from"./runtime.B-tQERhy.js";import{d as et,s as tt,b as S,e as U}from"./store.hrIEzNxT.js";import{i as T,p as x}from"./if.DYHPrnE1.js";import{e as Le,s as K,t as ot,f as at,a as nt}from"./index.CapXeD3F.js";import{c as it,b as st}from"./preload-helper.Cgn74BMC.js";import{a as me}from"./Icon.CwQkWwrI.js";import{U as rt,s as lt,m as qe,b as dt,t as ie,l as ct,p as _t,d as pt,a as gt,r as Be,f as mt,c as ft,e as ut,h as bt}from"./modal.DQW4ZWZ4.js";import{o as vt}from"./index-client.BfaqMVnR.js";import{D as ht,B as yt,d as kt,m as Ne,u as wt,a as fe,L as He,C as Oe}from"./DropIndicator.DVAXFL8c.js";import{p as $t}from"./stores.Djv4k36v.js";import{dropTargetForElements as Ue}from"./element-adapter.CmHsh92p.js";import{attachClosestEdge as Pe,extractClosestEdge as j}from"./closest-edge.DKVUyjvI.js";import{b as xt}from"./entry.Cv1PstCO.js";import{h as Dt}from"./hydration.BcoAblzY.js";var Ct=P('<div class="spinner svelte-gf3405" style="--Spinner-color: var(--color-gray-7);"><!></div>'),Et=P('<div role="presentation" class="svelte-gf3405"><!> <!></div>'),St=P('<div role="presentation" class="empty-state svelte-gf3405">Drag blocks here to add them to the page</div>'),Tt=P('<div data-type="palette" class="svelte-gf3405"><!></div>'),It=P('<div role="presentation" data-type="static" class="svelte-gf3405"><!> <!></div>'),Lt=P('<!> <!> <!> <main id="Page" class="svelte-gf3405"></main>',1);function Kt(Re,se){Me(se,!0);const D=tt(),ue=()=>S($t,"$page_store",D),C=()=>S(lt,"$sections",D),re=()=>S(ct,"$locked_blocks",D),Ve=()=>S(_t,"$page_loaded",D),ze=()=>S(pt,"$dragging_symbol",D),We=()=>S(gt,"$locale",D),le=()=>S(ft,"$symbols",D),Xe=()=>S(ut,"$active_page",D);let R=v(!1),V=v(0);xt(()=>{i(R,!1),i(V,0)});const A=bt();async function de(t){Be({instance:A,user:ue().data.user,data:{active_block:t}})}function G(){Be({instance:A,user:ue().data.user,data:{active_block:null}})}let d=v(null),y=v(void 0),m=v(void 0),E=v(void 0),N=v(!1);async function M(){e(N)||(i(N,!0),await ne(),ce(),e(y).addEventListener("scroll",()=>{I()}))}async function ce(){if(await ne(),!e(m)||!e(E))return;e(m).appendChild(e(E));const{top:t,left:o,bottom:a,right:n}=e(m).getBoundingClientRect(),s=41,w={top:(t<=s?s:t)+window.scrollY,bottom:a>=window.innerHeight?0:window.innerHeight-a,left:o,right:window.innerWidth-n-window.scrollX};e(E).style.top=`${w.top}px`,e(E).style.bottom=`${w.bottom}px`,e(E).style.left=`${w.left}px`,e(E).style.right=`${w.right}px`}async function I(){i(N,!1),await ne()}let h=v(void 0),H=v(!1);async function be(){e(H)||(i(H,!0),await ne(),e(y).addEventListener("scroll",Q))}async function Q(){if(!e(m)||!e(h))return;e(m).appendChild(e(h));const{top:t,left:o,bottom:a,right:n}=e(m).getBoundingClientRect(),s={top:(t<=41?41:t)+window.scrollY,bottom:a>=window.innerHeight?0:window.innerHeight-a,left:o,right:window.innerWidth-n-window.scrollX};e(h).style.left=`${s.left}px`,e(h).style.right=`${s.right}px`,k.position==="top"||e(u).length===0?e(h).style.top=`${s.top}px`:e(h).style.top="initial",k.position==="bottom"||e(u).length===0?e(h).style.bottom=`${s.bottom}px`:e(h).style.bottom="initial"}function Ye(){i(H,!1),e(y).removeEventListener("scroll",Q)}function ve(t,o=!1){de(t);const a=C().find(n=>n.id===t);qe.show("SECTION_EDITOR",{component:a,tab:o?"code":"content",header:{title:"Edit Block",icon:o?"fas fa-code":"fas fa-edit",onclose:()=>{G()},button:{icon:"fas fa-check",label:"Save",onclick:(n,s)=>{G(),dt({page_id:se.page.id}),qe.hide(),wt(t,{updated_data:n,changes:s})}}}},{showSwitch:!0,disabledBgClose:!0})}let z=v(!1),he=[];function Fe(){he.forEach(t=>{t&&t.parentNode&&t.parentNode.removeChild(t)}),he=[]}vt(()=>{Fe()});let k={id:null,position:null};function Z(){k={id:null,position:null},i(ee,!1),Ye()}let ee=v(!1);function Je(t){Ue({element:t,getData({input:o,element:a}){return Pe({},{element:a,input:o,allowedEdges:["top","bottom"]})},async onDrag({self:o,source:a}){var s;if(e(ee))return;const n=(s=e(u)[e(u).length-1])==null?void 0:s.id;n&&(i(m,x(e(y).querySelector(`[data-section="${n}"]`))),e(H)||await be(),Q(),(k.id!==n||k.position!==j(o.data))&&(k={id:n,position:j(o.data)}))},onDragLeave(){Z()},async onDrop({source:o}){if(e(ee))return;const a=o.data.block,n=await fe({palette_id:e(_e).id,symbol:a,position:e(u).length});e(y).querySelector(`[data-section="${n}"]`).scrollIntoView({behavior:"smooth",block:"center",inline:"center"}),Z()}})}function ye(t,o){Ue({element:t,getData({input:a,element:n}){return Pe({section:o},{element:n,input:a,allowedEdges:["top","bottom"]})},async onDrag({self:a,source:n}){i(m,x(a.element)),e(H)||await be(),Q(),(k.id!==a.data.section.id||k.position!==j(a.data))&&(k={id:a.data.section.id,position:j(a.data)})},onDragEnter(){i(ee,!0)},onDragLeave(){Z()},async onDrop({self:a,source:n}){const s=e(u).length===0,w=C().find(c=>c.id===a.data.section.id).index,te=n.data.block,b=j(a.data);if(b==="top"){const c=await fe({palette_id:e(_e).id,symbol:te,position:s?0:w});e(y).querySelector(`[data-section="${c}"]`).scrollIntoView({behavior:"smooth",block:"center",inline:"center"})}else if(b==="bottom"){const c=await fe({palette_id:e(_e).id,symbol:te,position:s?0:w+1});e(y).querySelector(`[data-section="${c}"]`).scrollIntoView({behavior:"smooth",block:"center",inline:"center"})}Z()}})}Qe(()=>{Dt(se.page)});let ke=l(()=>C().length===1),Ke=l(()=>C().filter(t=>t.palette||t.master.symbol));Te(()=>{e(V)===e(Ke).length&&e(V)!==0?i(R,!0):e(ke)&&i(R,!0)});let _e=l(()=>C().find(t=>{var o;return!t.symbol&&!((o=t.master)!=null&&o.symbol)})),we=l(()=>re().find(t=>{var o;return t.block_id===((o=e(d))==null?void 0:o.id)}));Te(()=>{e(we)&&I()});let $e=l(()=>C().filter(t=>!t.palette)),u=l(()=>C().filter(t=>t.palette));var xe=Lt(),De=oe(xe);T(De,()=>!e(R)&&C().length>1,t=>{var o=Ct(),a=ae(o);it(a,()=>rt.Spinner,(n,s)=>{s(n,{variant:"loop"})}),Y(o),$(t,o)});var Ce=F(De,2);T(Ce,()=>e(H),t=>{ht(t,{get node(){return e(h)},set node(o){i(h,x(o))}})});var Ee=F(Ce,2);T(Ee,()=>e(N)&&!e(we),t=>{yt(t,{get node(){return e(E)},set node(o){i(E,x(o))},get id(){return e(d).id},get i(){return e(d).index},get is_instance_block(){return e(d).master},get is_last(){return e(d).is_last},$$events:{delete:async()=>{I(),kt(e(d).id)},"edit-code":()=>ve(e(d).id,!0),"edit-content":()=>ve(e(d).id),moveUp:async()=>{i(z,!0),I(),await Ne(e(d),e(d).index-1),setTimeout(()=>{i(z,!1)},300)},moveDown:async()=>{i(z,!0),I(),await Ne(e(d),e(d).index+1),setTimeout(()=>{i(z,!1)},300)}}})});var L=F(Ee,2);st(L,t=>i(y,t),()=>e(y)),Le(L,21,()=>e($e).sort((t,o)=>t.master.index-o.master.index),t=>t.id,(t,o)=>{var a=ge();const n=l(()=>{var b;return!e(o).symbol&&!((b=e(o).master)!=null&&b.symbol)}),s=l(()=>!e(z)&&!(e(n)&&e(u).length===0)),w=l(()=>le().some(b=>b.page_types.includes(Xe().page_type.id)));var te=oe(a);T(te,()=>e(n)&&e(w),b=>{var c=Tt(),W=ae(c);T(W,()=>e(u).length>0,X=>{var r=ge(),q=oe(r);Le(q,25,()=>e(u).sort((B,_)=>B.index-_.index),B=>B.id,(B,_)=>{var p=Et();const g=l(()=>le().find(f=>f.id===e(_).symbol)),pe=l(()=>re().find(f=>f.block_id===e(_).id)),je=l(()=>{var f;return((f=e(pe))==null?void 0:f.instance)===A});p.__mousemove=M;var Se=ae(p);T(Se,()=>e(pe)&&!e(je),f=>{He(f,{get locked(){return e(pe)}})});var Ae=F(Se,2);Oe(Ae,{get block(){return e(g)},get section(){return e(_)},$$events:{lock:()=>de(e(_).id),unlock:()=>G(),mount:()=>Ie(V),resize:()=>{e(N)&&ce()}}}),Y(p),J(()=>{K(p,"data-section",e(_).id),K(p,"data-symbol",e(g).id)}),U("mouseenter",p,async({target:f})=>{i(d,x({...e(_),is_last:e(_).index===e(u).length-1})),i(m,x(f)),e(s)&&M()}),U("mouseleave",p,I),ot(1,p,()=>at,()=>({duration:100})),nt(p,()=>mt,()=>({duration:100})),me(p,(f,Ge)=>ye(f,Ge),()=>e(_)),$(B,p)}),$(X,r)},X=>{var r=St();J(()=>ie(r,"page_is_empty",e(ke))),U("mouseenter",r,async({target:q})=>{i(m,x(q))}),U("mouseleave",r,()=>{i(m,null)}),me(r,(q,O)=>ye(q,O),()=>e(o)),$(X,r)}),Y(c),J(()=>{K(c,"data-section",e(o).id),ie(c,"empty",e(u).length===0)}),$(b,c)},b=>{var c=ge(),W=oe(c);T(W,()=>!e(n),X=>{var r=It();const q=l(()=>le().find(g=>g.id===e(o).master.symbol)),O=l(()=>re().find(g=>g.block_id===e(o).id)),B=l(()=>{var g;return((g=e(O))==null?void 0:g.instance)===A});r.__mousemove=M;var _=ae(r);T(_,()=>e(O)&&!e(B),g=>{He(g,{get locked(){return e(O)}})});var p=F(_,2);Oe(p,{get block(){return e(q)},get section(){return e(o)},$$events:{lock:()=>de(e(o).id),unlock:()=>G(),mount:()=>Ie(V),resize:()=>{e(N)&&ce()}}}),Y(r),J(()=>K(r,"data-section",e(o).id)),U("mouseenter",r,async({target:g})=>{i(d,x({...e(o),is_last:e(o).index===e($e).length-1})),i(m,x(g)),M()}),U("mouseleave",r,I),$(X,r)},null,!0),$(b,c)}),$(t,a)}),Y(L),J(()=>{K(L,"lang",We()),ie(L,"fadein",Ve()&&e(R)),ie(L,"dragging",ze())}),me(L,t=>Je(t)),$(Re,xe),Ze()}et(["mousemove"]);export{Kt as P};
