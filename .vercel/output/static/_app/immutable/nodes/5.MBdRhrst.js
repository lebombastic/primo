import{a as F,t as j}from"../chunks/disclose-version.DwtFBC9D.js";import{t as I,c as v,r as m,p as J,a as K,q,g as M,S as Q,d as P,s as D,aS as L}from"../chunks/runtime.B-tQERhy.js";import{a as W,d as V,s as Z,e as R,b as ee}from"../chunks/store.hrIEzNxT.js";import{i as N,p as te}from"../chunks/if.DYHPrnE1.js";import{t as se,f as ae,e as ne,s as H,r as oe,b as re}from"../chunks/index.CapXeD3F.js";import{I as O,a as ie}from"../chunks/Icon.CwQkWwrI.js";import{p as le}from"../chunks/props.Pqwi89p5.js";import{p as X}from"../chunks/stores.Djv4k36v.js";import{s as $,a as ce,h as A,S as pe}from"../chunks/Modal.Bvi9X32r.js";import{g as de,c as ue}from"../chunks/entry.Cv1PstCO.js";import{S as fe}from"../chunks/ServerLogo.B562j9Sy.js";import{q as C,C as ve,D as G,E as me}from"../chunks/modal.DQW4ZWZ4.js";function _e({site:n,page_types:r,symbols:c,pages:h,sections:y}){const u=new Map;function E(s){return s?(u.has(s)||u.set(s,ve()),u.get(s)):null}function o(s){return s?u.get(s):null}function f(s){E(s.id),s.fields&&s.fields.forEach(e=>E(e.id)),s.entries&&s.entries.forEach(e=>E(e.id))}[n,...r,...c,...h,...y].forEach(f);function b(s){const e=C.cloneDeep(s);return e.id=o(s.id),e.fields&&(e.fields=e.fields.map(w=>p(w))),e.entries&&(e.entries=e.entries.map(w=>_(w))),e}function x(s){const e=b(s);return e.site=o(s.site),e}function S(s){const e=b(s);return e.page_type=o(s.page_type),e.parent=o(s.parent),e}function t(s){const e=b(s);return e.symbol=o(s.symbol),e.palette=o(s.palette),e.master=o(s.master),e.page=o(s.page),e.page_type=o(s.page_type),e}function p(s){var w,T;const e=C.cloneDeep(s);return e.id=o(s.id),e.parent&&(e.parent=o(e.parent)),(w=e.options)!=null&&w.source&&(e.options.source=o(e.options.source)),(T=e.options)!=null&&T.page_type&&(e.options.page_type=o(e.options.page_type)),e.source&&(e.source=o(e.source)),e.symbol=o(s.symbol),e.page_type=o(s.page_type),e.site=o(s.site),e}function _(s){var w;const e=C.cloneDeep(s);return e.id=o(s.id),e.field=o(s.field),e.parent=o(s.parent),(w=e.metadata)!=null&&w.page&&(e.metadata.page=o(e.metadata.page)),e.page=o(s.page),e.page_type=o(s.page_type),e.symbol=o(s.symbol),e.section=o(s.section),e.site=o(s.site),e}function g(s){const e=b(s);return e.site=o(s.site),e.page_types=s.page_types.map(o),e}const i=b(n),d=r.map(x),a=c.map(g),l=h.map(S),k=y.map(t);return{site:i,page_types:d,symbols:a,pages:l,sections:k}}const ge={create:async(n,r=null)=>{const c=_e(n),h=await U(c),y=B(c),{site:u,page_types:E,pages:o,symbols:f,sections:b,entries:x,fields:S}=y;try{let t=await $.from("sites").insert({...u,owner:de(X).data.user.id});if(t.error)throw console.log("Failed to insert site",{res:t,site:u}),new Error("Failed to insert site");if(t=await Promise.all([$.from("page_types").insert(E),$.from("symbols").insert(f)]),t.some(_=>_.error))throw console.log("Failed to insert page_types or symbols",{res:t,page_types:E,symbols:f}),new Error("Failed to insert page_types or symbols");if(t=await $.from("pages").insert(o),t.error)throw console.log("Failed to insert pages",{res:t,pages:o}),new Error("Failed to insert pages");if(t=await $.from("sections").insert(b),t.error)throw console.log("Failed to insert sections",{res:t,sections:b}),new Error("Failed to insert sections");if(t=await $.from("fields").insert(S),t.error)throw console.log("Failed to insert fields",{res:t,fields:S}),new Error("Failed to insert fields");if(t=await $.from("entries").insert(x),t.error)throw console.log("Failed to insert entries",{res:t,entries:x}),new Error("Failed to insert entries");r&&await $.storage.from("sites").upload(`${u.id}/preview.html`,r);const p=await G.post("/api/deploy/initial-deployment",{files:h,site_id:u.id,domain_name:u.domain_name});console.log({dist_res:p}),console.log("Site created successfully")}catch(t){console.error("SOMETHING WENT WRONG",t)}},update:async n=>{(void 0).update(n)},delete:async n=>{await $.from("sites").delete().eq("id",n),await G.delete(`/api/deploy/delete-deployment?site_id=${n}`)},deploy:async(n,r=null)=>{const{data:c,error:h}=await $.from("sites").select(`
				*,
				fields(*),
				entries(*),
				page_types(
					*,
					fields(*),
					entries(*),
					pages(
						*,
						entries(*),
						sections(*, entries(*))
					)
				),
				symbols(
					*,
					fields(*),
					entries(*)
				)
			`).eq("id",n).single();if(console.log({error:h,data:c}),!c)throw new Error("Could not find site");const y={site:C.omit(c,["pages","page_types","symbols","sections"]),pages:c.page_types.flatMap(f=>f.pages.map(b=>C.omit(b,["sections"]))),page_types:c.page_types.map(f=>C.omit(f,["pages"])),symbols:c.symbols,sections:c.page_types.flatMap(f=>f.pages.flatMap(b=>b.sections))};console.log({site_data:y});const u=await U(y),E=B(y),{site:o}=E;try{const f=await G.post("/api/deploy/initial-deployment",{files:u,site_id:o.id,domain_name:o.domain_name});console.log({dist_res:f}),console.log("Site created successfully")}catch(f){console.error("SOMETHING WENT WRONG",f)}}};function B(n){const r=C.omit(n.site,["entries","fields"]),c=n.page_types.map(t=>C.omit(t,["entries","fields"])),h=n.pages.map(t=>C.omit(t,["entries"])),y=n.sections.map(t=>C.omit(t,["entries"])),u=n.symbols.map(t=>C.omit(t,["entries","fields"])),E=x([...n.site.fields,...n.page_types.flatMap(t=>t.fields),...n.symbols.flatMap(t=>t.fields)]),o=S([...n.site.entries,...n.page_types.flatMap(t=>t.entries),...n.pages.flatMap(t=>t.entries),...n.sections.flatMap(t=>t.entries),...n.symbols.flatMap(t=>t.entries)]);return{site:r,page_types:c,pages:f(h),sections:b(y),symbols:u,fields:E,entries:o};function f(t){const p=new Map(t.map(a=>[a.id,a])),_=[],g=new Set,i=new Set;function d(a){if(i.has(a))throw new Error("Circular dependency detected in pages");if(g.has(a))return;i.add(a);const l=p.get(a);l.parent&&p.has(l.parent)&&d(l.parent),i.delete(a),g.add(a),_.push(l)}for(const a of t)g.has(a.id)||d(a.id);return _}function b(t){const p=new Map(t.map(a=>[a.id,a])),_=[],g=new Set,i=new Set;function d(a){if(i.has(a))throw new Error("Circular dependency detected in sections");if(g.has(a))return;i.add(a);const l=p.get(a);l.master&&p.has(l.master)&&d(l.master),l.palette&&p.has(l.palette)&&d(l.palette),i.delete(a),g.add(a),_.push(l)}for(const a of t)g.has(a.id)||d(a.id);return _}function x(t){const p=new Map(t.map(a=>[a.id,a])),_=[],g=new Set,i=new Set;function d(a){var k;if(i.has(a))throw new Error("Circular dependency detected in fields");if(g.has(a))return;i.add(a);const l=p.get(a);l.parent&&p.has(l.parent)&&d(l.parent),(k=l.options)!=null&&k.source&&p.has(l.options.source)&&d(l.options.source),i.delete(a),g.add(a),_.push(l)}for(const a of t)g.has(a.id)||d(a.id);return _}function S(t){const p=new Map(t.map(a=>[a.id,a])),_=[],g=new Set,i=new Set;function d(a){if(i.has(a))throw new Error("Circular dependency detected in entries");if(g.has(a))return;i.add(a);const l=p.get(a);l.parent&&p.has(l.parent)&&d(l.parent),i.delete(a),g.add(a),_.push(l)}for(const a of t)g.has(a.id)||d(a.id);return _}}async function U({pages:n,symbols:r,site:c,page_types:h,sections:y}){const u=await Promise.all(n.map(f=>o(f,"en"))),E=[];return C.flattenDeep([...E,...u.flat()]);async function o(f,b){var k,s;const{slug:x}=f,S=y.filter(e=>e.page===f.id);let t=[];const p=S.filter(e=>e.master);for(const e of p)if((k=e.master)!=null&&k.symbol&&t.push({...e,index:e.master.index}),!((s=e.master)!=null&&s.symbol)){const w=S.filter(T=>T.palette).sort((T,Y)=>T.index-Y.index);w.index=e.master.index,t.push(w)}t=t.sort((e,w)=>e.index-w.index),t=t.flat();const _=h.find(e=>e.id===f.page_type),{html:g}=await me({site:c,page:{...f,page_type:_},page_sections:t,page_symbols:r,page_list:n,page_types:h,locale:b});let i=[];const d=n.find(e=>e.id===f.parent);if(d){let e=!1,w=d;for(i.push(d.slug);!e;)w=n.find(T=>T.id===w.parent),w?i.unshift(w.slug):e=!0}let a;return x===""?a="index.html":x==="404"?a="404.html":d?a=`${i.join("/")}/${x}/index.html`:a=`${x}/index.html`,[{path:a,content:g}]}}function he(n){const r=c=>{n&&!n.contains(c.target)&&!c.defaultPrevented&&n.dispatchEvent(new CustomEvent("click_outside",n))};return document.addEventListener("click",r,!0),{destroy(){document.removeEventListener("click",r,!0)}}}var ye=j('<span class="letter svelte-1pg8fna"><span class="inner-letter svelte-1pg8fna"> </span></span>');function z(n,r){let c=le(r,"letter",3,"b");var h=ye(),y=v(h),u=v(y,!0);m(y),m(h),I(()=>W(u,c())),F(n,h)}var we=(n,r)=>q(r,!M(r)),be=async(n,r)=>{await r().data.supabase.auth.signOut(),window.location.reload()},Ee=j('<div class="popup svelte-1u5so7j"><div class="row svelte-1u5so7j"><!> <span class="email svelte-1u5so7j"> </span></div> <hr class="svelte-1u5so7j"> <button class="row svelte-1u5so7j"><div class="icon svelte-1u5so7j"><!></div> <span>Sign Out</span></button></div>'),Se=j('<div class="MenuPopup svelte-1u5so7j"><button class="open-popup svelte-1u5so7j"><!> <!></button> <!></div>');function ke(n,r){J(r,!0);const c=Z(),h=()=>ee(X,"$page",c);let y=Q(!1);var u=Se(),E=v(u);E.__click=[we,y];var o=v(E),f=P(()=>h().data.user.email.slice(0,1));z(o,{get letter(){return M(f)}});var b=D(o,2),x=P(()=>`mdi:chevron-${(M(y)?"up":"down")??""}`);O(b,{get icon(){return M(x)}}),m(E);var S=D(E,2);N(S,()=>M(y),t=>{var p=Ee(),_=v(p),g=v(_),i=P(()=>h().data.user.email.slice(0,1));z(g,{get letter(){return M(i)}});var d=D(g,2),a=v(d,!0);m(d),m(_);var l=D(_,4);l.__click=[be,h];var k=v(l),s=v(k);O(s,{icon:"mdi:sign-out"}),m(k),L(2),m(l),m(p),I(()=>W(a,h().data.user.email)),se(1,p,()=>ae,()=>({duration:100})),F(t,p)}),m(u),R("click_outside",u,()=>q(y,!1)),ie(u,t=>he(t)),F(n,u),K()}V(["click"]);var xe=j('<header role="navigation" aria-label="main navigation" class="svelte-w4v1k2"><div class="logo svelte-w4v1k2"><!></div> <nav class="nav svelte-w4v1k2"><!></nav></header>');function Me(n){var r=xe(),c=v(r),h=v(c);fe(h),m(c);var y=D(c,2),u=v(y);ke(u,{}),m(y),m(r),F(n,r)}function Fe(){ce({id:"CREATE_SITE",options:{disable_bg_close:!0},props:{onSuccess:async(n,r)=>{console.log({site:n}),await ge.create(n,r),ue("app:data"),A()},onCancel:A}})}var Ce=j('<form><input class="reset-input svelte-1pa8200" type="text"></form>'),je=j('<a data-sveltekit-prefetch="" class="svelte-1pa8200"><span> </span> <!></a>'),Te=(n,r,c)=>q(r,te(M(c).id)),$e=j('<div class="buttons svelte-1pa8200"><button class="site-button svelte-1pa8200"><!> <span class="svelte-1pa8200">Rename</span></button></div>'),De=j('<li class="svelte-1pa8200"><a class="site-link svelte-1pa8200"><!></a> <div class="site-info svelte-1pa8200"><div class="site-name svelte-1pa8200"><!></div> <!></div></li>'),Oe=j('<div class="icon svelte-1pa8200"><!></div>'),Ne=j('<div class="icon svelte-1pa8200"><!></div>'),qe=j('<li class="svelte-1pa8200"><button class="create-site svelte-1pa8200"><!> Create a site</button></li>'),Ie=j('<main class="primo-reset svelte-1pa8200"><div class="container svelte-1pa8200"><!> <div class="sites-container svelte-1pa8200"><ul class="sites svelte-1pa8200"><!> <!></ul></div></div></main>');function Qe(n,r){J(r,!0),console.log({data:r.data});let c,h=Q(void 0);var y=Ie(),u=v(y),E=v(u);Me(E);var o=D(E,2),f=v(o),b=v(f);ne(b,17,()=>r.data.sites,S=>S.id,(S,t)=>{var p=De(),_=v(p),g=v(_);pe(g,{get site(){return M(t)}}),m(_);var i=D(_,2),d=v(i),a=v(d);N(a,()=>M(h)===M(t).id,k=>{var s=Ce(),e=v(s);oe(e),m(s),R("submit",s,w=>{w.preventDefault(),q(h,null)}),R("blur",e,()=>q(h,null)),re(e,()=>M(t).name,w=>M(t).name=w),F(k,s)},k=>{var s=je(),e=v(s),w=v(e,!0);m(e);var T=D(e,2);O(T,{icon:"ic:round-chevron-right"}),m(s),I(()=>{H(s,"href",M(t).id),W(w,M(t).name)}),F(k,s)}),m(d);var l=D(d,2);N(l,()=>!r.data.user.collaborator,k=>{var s=$e(),e=v(s);e.__click=[Te,h,t];var w=v(e);O(w,{icon:"material-symbols:edit-square-outline-rounded"}),L(2),m(e),m(s),F(k,s)}),m(i),m(p),I(()=>H(_,"href",M(t).id)),F(S,p)});var x=D(b,2);N(x,()=>!r.data.user.collaborator,S=>{var t=qe(),p=v(t);p.__click=[Fe];var _=v(p);N(_,()=>c,g=>{var i=Oe(),d=v(i);O(d,{icon:"eos-icons:loading"}),m(i),F(g,i)},g=>{var i=Ne(),d=v(i);O(d,{icon:"ic:round-plus"}),m(i),F(g,i)}),L(),m(p),m(t),F(S,t)}),m(f),m(o),m(u),m(y),F(n,y),K()}V(["click"]);export{Qe as component};
